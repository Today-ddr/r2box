name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Releasing version: ${VERSION}"

      - name: Get previous tag
        id: prev_tag
        run: |
          # Get the previous tag for changelog generation
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            # If no previous tag, use the first commit
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Previous tag: ${PREV_TAG}"

      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          # Get commits since last tag, grouped by type
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

          # Features
          FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^feat" --regexp-ignore-case 2>/dev/null || true)
          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features" >> RELEASE_NOTES.md
            echo "$FEATURES" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Bug fixes
          FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^fix" --regexp-ignore-case 2>/dev/null || true)
          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> RELEASE_NOTES.md
            echo "$FIXES" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Documentation
          DOCS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^docs" --regexp-ignore-case 2>/dev/null || true)
          if [ -n "$DOCS" ]; then
            echo "### ðŸ“š Documentation" >> RELEASE_NOTES.md
            echo "$DOCS" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Performance
          PERF=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^perf" --regexp-ignore-case 2>/dev/null || true)
          if [ -n "$PERF" ]; then
            echo "### âš¡ Performance" >> RELEASE_NOTES.md
            echo "$PERF" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Other changes (not matching conventional commit types)
          OTHER=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --invert-grep --grep="^feat\|^fix\|^docs\|^perf\|^chore\|^style\|^refactor\|^test\|^ci\|^build" --regexp-ignore-case 2>/dev/null || true)
          if [ -n "$OTHER" ]; then
            echo "### ðŸ”§ Other Changes" >> RELEASE_NOTES.md
            echo "$OTHER" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Add Docker image info
          echo "---" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ³ Docker Image" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "\`\`\`bash" >> RELEASE_NOTES.md
          echo "docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ steps.version.outputs.tag }}" >> RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: R2Box ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Trigger Docker build after release is created
  trigger-docker-build:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Docker workflow
        run: |
          echo "Docker build will be triggered automatically by the tag push"
          echo "The docker-publish.yml workflow handles building and pushing the image"
